# Project_X CRM
1. [Задание на разработку](#1) 
2. [Уточнение требований](#2)
3. [Разработки группы](#%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D0%BA%D0%B8-%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B)
4. [Доменная модель](#%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C) 

## 1 
## Задание на разработку 
### Вводные данные:
Имеется система CRM для телекоммуникационной компании с количеством операторов в 100 человек.
CRM состоит из:
* Клиентов (физические и юридические лица)
* Заказов (заказы на услуги, предоставляемые компанией клиенту)
* Обращений (обращения в техническую поддержку)
* Менеджера задач (Kanban-доска для отработки обращений, содержит доски, задачи, витрину с динамическими фильтрами)

### WorkFlow:
* Пользователь авторизуется в CRM
  * Профиль пользователя;
  * Уведомления пользователя.
* Пользователю доступны клиенты
  * Возможность просматривать список клиентов;
  * Возможность поиска по имени клиента;
  * Возможность редактировать клиента;
  * Возможность создавать клиента.
* Пользователю доступны заказы
  * Возможность просматривать список заказов по клиенту;
  * Возможность просматривать список заказов;
  * Возможность поиска заказа;
  * Возможность создавать заказ на клиента.
* Пользователю доступны обращения
  * Возможность просматривать обращения;
  * Возможность создавать обращение на клиента;
  * Возможность закрывать обращение.
* Пользователю доступен менеджер задач
  * Пользователю создается доска;
  * При создании обращения на доске создается задача;
  * У задачи имеется бизнес-процесс;
  * По завершению задачи, она закрывается, автоматически закрывается обращение, нотифицируется (менеджеру, клиенту).
* Имеется интеграция во внешние системы(входящая/исходящая)
Менеджер задач содержит витрину, на которой отображается информация по задачам. Применяются динамические фильтры.

Время отклика не более 1 секунды. Система должна быть отказоустойчивой (выбрать способ) и высоконагруженной (500 rps);

### Решаемые задачи:
1. Разработать доменную модель (любая нотация);
2. Выработать единую архитектуру (монолит, SOA, MSA), с описанием, почему выбран именно такой подход;
3. Подготовить оптимальное интеграционное решение;
4. Выбрать способ обеспечения отказоустойчивости и работы под нагрузкой;
5. Реализовать блок-схему\диаграмму архитектурного решения, возможно по этапам Day 0-Daу 2;
6. Выбрать Языки и Стек технологий c альтернативным решением (основная технология + альтернативная технология) с таблицей сравнительной оценки предпочтительной (из лекции 5, модуля 4, в приложении), дать оценку для 1,2-х главных технологий.
7. Оценить техническую инфраструктуру, вычислители, ОЗУ, долговременное хранилище, сеть, на период 5 лет эксплуатации.
8. Дополнительно: оценить общую трудоёмкость решения (должности в разработке и человеко/месяцы трудозатрат)

### Отчётные документы:
1. Документы должны содержать следующие диаграммы: Use Case, ERD, DFD, Sequence Diagram (общая и несколько детальных), Class Diagram, Component Diagram, Deploy Diagram, Интеграционную диаграмму, Архитектуру БД;
2. Подготовить документацию API (Swagger);
3. Результат представить в виде 2-х документов:
  * Текстовый документ формата A4 c диаграммами, таблицами и комментариями.
  * Презентация по ключевым диаграммам и идеям. 
Компоненты Клиент и Заказы являются legacy с более старым стеком. Попробовать внедрить legacy в новую архитектуру.

## 2 
## Уточнение требований
### Блок 1


### Блок 2
* **Вопрос 1:** Например, в ТЗ указано «Компоненты Клиент и Заказы являются legacy с более старым стеком» - может у нас этот функционал по обработке клиентов/заказов не делать, но сделать сервисы-прокси до легаси, которые нашему сервису дадут нормальный API, а сами инкапсулируют в себе «сложную» логику общения с легаси. Зная Ростелек, там наверняка SOAP и  ESB.
* **Ответ:** Вариант решения - ваше предложение, можно интегрировать через «Слой защиты от повреждений/прокси», два варианта 1) Реплика продуктовой БД, 2) Фасад API шлюз.
* **Вопрос 2:** Далее по сервису авторизации-аутентификации. Он наверняка у них есть, но на крайняк можно взять готовое решение Keycloak, например, или другой любой identity Manager. Он на себя заберет большую часть мороки с пользователями, их ролями и тд. Но целевое - использовать что-то из ландшафта.
* **Ответ:** Оценить несколько технологий и на основе анализа предложить свой вариант, понимая, что это телеком под регулированием.
* **Вопрос 3:** Уведомления - не очень понятно, кто кого должен уведомлять, что есть триггер.
* **Ответ:** О получении заявки в техническую поддержку оператору. О статусах задачи клиенту.
* **Вопрос 4:** Процесс работы с обращениями - 100% надо прикручивать BPMN-движок (camunda, etc) или что-то аналогичное. Туда вытаскивается все бизнес-логика - отправить уведомлений, что-нибудь автоматически сделать, задачи оркестровки). Зуб даю, всегда ничается с «да нам хватит три статуса, а после Иванова всегда согласовывает Петров», а заканчивается параллельными конкуретными согласованиями и тд.
* **Ответ:** Как вариант. Принцип Open-Closed.
* **Вопрос 5:** Текущая CRM.
    1.1. Не понятно, что есть на текущий момент. Возможно то, что перечислено в списке «CRM состоит из»? Это какая-то монолитная система?
* **Ответ:** CRM Существует, её элементы можно интегрировать через «Слой защиты от повреждений/прокси», два варианта 1) Реплика продуктовой БД, 2) Фасад API шлюз 
* **Вопрос 6:** Какая наша задача? «Переписать» на новый стек и новую архитектуру? А чем старая не устраивает и можно ли посмотреть на ее архитектуру?
* **Ответ:** Да, а РТК уже имеются CRM системы и они работают. Задача для команд предложить ВАРИАНТ архитектуры в которой будет возможность интеграции как наследованных компонент, так и точки для внешних систем. По сути необходимо разработать архитектуру CRM с "чистого листа". Посмотреть нет возможности.
* **Вопрос 7:** Что из перечисленного WorkFlow в ней отсутствует?
* **Ответ:** Все задачи перечисленного WorkFlow требуют реализации в новой архитектуре.
* **Вопрос 8:** Мы делаем решение строго для одного предприятия или планируем «продавать» решение сторонним организациями? Если да - то по какой модели (SAAS, «коробка»).
* **Ответ:** Внутренний продукт.  SAAS возможен, через 5 лет. Можно заложить базовые идеи, но сильно не погружаться.
* **Вопрос 9:** Профиль сотрудника, аутентификация.
    9.1. Есть ли централизованный Identity and Access Management?
    9.2. Является ли этот сервис мастером по профилю сотрудников?
    9.3. Можно ли «подписываться» на изменения (создания пользователя, изменения его данных и тд)?
* **Ответ:** Используйте «Инверсию зависимостей»
* **Вопрос 10:** Есть ли в ландшафте сервис отправки уведомлений, какой его функционал.
* **Ответ:** Да, используйте «Инверсию зависимостей»
* **Вопрос 11:** Вопрос про Legacy-компоненты (клиенты, заказы). Чтобы понять, можем ли мы их не выводить из эксплуатации и переиспользовать, хотелось бы увидеть их API, а так же понимать, какое кол-во сервисов еще взаимодействует с Legacy-компонентами.
* **Ответ:** CRM Существует, её элементы можно интегрировать через «Слой защиты от повреждений/прокси», два варианта 1) Реплика продуктовой БД, 2) Фасад API шлюз
* **Вопрос 12:** Сейчас как-то автоматизирован процесс работы с обращениями?
* **Ответ:** На проприетарных решениях. Используйте «Инверсию зависимостей»
* **Вопрос 13:** Какой вид авторизации используется в Ростелекоме как стандарт, делать свою или какой-нибудь внутренний LDAP Свое + Oauth
* **Ответ:** Оценить несколько технологий и на основе анализа предложить свой вариант, понимая, что это телеком под регулированием.
* **Вопрос 14:** Какая информация необходима по пользователю в профиле и возможности которые он должен предоставлять
* **Ответ:** Предложить из доменной модели (провести исследование). Не будет считаться ошибкой наличие или отсутствие каких-либо элементов.
* **Вопрос 16:** Примерное кол-во клиентов и примерный (наверно рост) согласно аналитике в ближайшее будущее (на сколько ждать масштабирование)
* **Ответ:** По 500 операторов в год примерно.
* **Вопрос 17:** Какие параметры имеют клиенты и какие параметры являются редактируемые 
* **Ответ:** Предложить из доменной модели (провести исследование). Не будет считаться ошибкой наличие или отсутствие каких-либо элементов.
* **Вопрос 18:** Поиск только по имени? Если у нас будет 250 тыс. Сергеев, например, способности фильтрации явно должны быть интереснее ФИО + Номер + ?
* **Ответ:** Предложите вариант.
* **Вопрос 19:** Каналы взаимодействия по обращениям 
* **Ответ:** Используйте «Инверсию зависимостей»
* **Вопрос 20:** Кол-во обращений в день 
* **Ответ:** От 100 в сутки с приростом до 5000 в сутки в течении 1 года.
* **Вопрос 21:** Способы распределения обращений автомат или ручное
* **Ответ:** Используйте Open-Closed принцип и паттерн «Стратегия».
* **Вопрос 22:** Не совсем понятно зачем отдельная сущность задач, почему нельзя делать всё в рамках обращений, какие статусы по бизнес процессу у задачи могут быть. В целом интересует связка заказ-обращение-задача. Терминология.
* **Ответ:** У каждой сущности разный жизненный цикл. При этом можно использовать паттерн «Обёртка» и «Цепочка обязанностей». Предложите вариант исходя их доменной модели.
* **Вопрос 23:** Мы заменяем текущее решение? или добавляем к текущему решению что-то новое? Вопрос в переиспользовании ресурсов легаси системы, тогда нужно понимать сколько сейчас используется.
* **Ответ:** Да, а РТК уже имеются CRM системы и они работают. Задача для команд предложить ВАРИАНТ архитектуры в которой будет возможность интеграции как наследованных компонент, так и точки для внешних систем. По сути необходимо разработать архитектуру CRM с "чистого листа.
Существующие элементы можно интегрировать через «Слой защиты от повреждений/прокси», два варианта 1) Реплика продуктовой БД, 2) Фасад API шлюз
* **Вопрос 24:** Почему срок хранения 5 лет, а не 3, как в нормативных документах РФ 
* **Ответ:** Требования заказчика.
* **Вопрос 25:** Уровень критичности системы 
* **Вопрос 26:** Требования к хранению данных ИБ Ростелеком на внутренней инфре 
* **Вопрос 27:** Требования доступности системы
* **Ответ:** Можно взять как референс из общих требований к телекому.
* **Вопрос 28:** Зависимости и понятия сущеностей (клиент, обращение, задача, заказ) 
* **Ответ:** Из доменной модели
* **Вопрос 29:** Текущая инфраструктура CI\CD, можем ли ее использоваться (git, jenkins, kubernetes)
* **Ответ:** Да, возможно:** Предложите свой вариант исходя из рисков поставщиков.
* **Вопрос 30:** По тексту задания сейчас получается, что у менеджера и пользователя примерно одни и те же возможности в системе. Нужно ли продумывать ролевую модель или достаточно ограничиться типом "Пользователь"? Если добавляем менеджера, какие дополнительные права ему можно предоставить?
* **Ответ:** Используйте принцип «Единственной ответсвенности» и «Open-Closed»

### Блок 3
* **Вопрос 1:** Еще раз про сервис, который мы проектируем. Правильно ли понимаем, что мы не замахиваемся на функционал CRM, а фактически делаем удобный dashboard и автоматизацию по работе с обращениями и заказами?
* **Ответ:** Да.По сути CRM уже имеется, и её базовые функции реализованы (ведение базы данных по клиентам, заказам/обращениям). Но это тоже может подлежать модификации.
* **Вопрос 2:** Наверняка, «сейчас» обращения (интеракции) поступают из нескольких каналов: call-центр, сайт, мобильное приложение, офис и т.д., и видимо попадают в CRM систему. Правильным ли будет такой тезис: «Мастером обращений остается текущая CRM. Обращения, созданные, через проектируемый сервис так же должны попадать в CRM. Работа с обращениями выполняется в проектируемом сервисе, в CRM передаем статусы обращении (новый/в обработке/закрыт и тд.». 
* **Ответ:** Да.
* **Вопрос 3**. Можно ли «подписаться» на появления новых обращений по различным каналам? Нам их забирать из какой-то очереди, или из poll-ить CRM-ку, или еще как-то?
* **Ответ:** Вытягивать из реплики БД, другой вариант по API.
* **Впорос 4:** Мы хотим оставить Клиенты/Заказы в legacy сервис. В проектируемом сервисе дадим возможность создавать/изменять, но будем передавать эту информацию в legacy. Вопрос - нам хранить у себя реплики заказов/клиентов? Но тогда legacy системе придется рассылать нотификации об изменении данных клиентов, чтобы у нас реплика не устаревала. Или лучше у себя вообще не хранить никакую информацию по клиентам/заказам, а по необходимости извлекать эту информацию из legacy?
* **Ответ:** Обратно в legacy не возвращаем. Но дописываем в ту реплику БД которую взяли из legacy.
* **Вопрос 5:** На сколько я знаю, в CRM - любое взаимодействие с клиентом называется интеракцией. Вопрос. «Обращение» из описание задания - интеракция или результат интеракции? И надо ли отслеживать интеракции по обращению?
* **Ответ:** «Обращение» – сущность.


## Разрабоки группы
* [Заготовка к презентации](https://docs.google.com/presentation/d/1y6QWRaDwOO5-LOeqW3I-x9YwzwfJVJZlM5_qJC_9oBw/edit?usp=sharing)
* [Схемы](https://drive.google.com/file/d/167fYQh3RjtNu08GgwGgpsxvGoYCHqj8s/view?usp=sharing)

## Доменная модель
### Поддомены
####  Бизнес
* Клиент - физические или юридические лица, покупатели услуг. 
* Услуга - основной источник денежных средств в данном случае основной продукт компании
* Заказ - сущность объединяющая несколько услуг, для одного клиента
* Обращение - любой контакт клиента с системой
* Уведомление - 
* Задача - действие/действия, которые необходимо выполнить для оказания услуги клиенту
* Доска задач - список задач, которые необходимо выбрать пользователю

| Определение      | Сущности и Агрегаты | Модуль |
|:--|:--|:--|
|Клиент|Client|Clients|
|Услуга|Service|Products|
|Заказ|Order|Orders|
|Обращение|Appeal|Appeals|
|Уведомление|Notification|Notifications|
|Задача|Task|Tasks|
|Доска задач|Board|Boards|

#### Безопасность
* Пользователь - пользователь системы, 
* Полномочие - атомарное разрешение на выполнение какого-либо действия в системе;
* Роль - набор полномочий объединенных под одним именем.

| Определение      | Идентификатор   | Модуль |
|:--|:--|:--|
|Пользователь|User|Users|
|Полномочие|Entitlement|Entitlements|
|Роль|Role|Roles|

В системе определены 3 роли: 
* Администратор - имеет полномочия на присвоение ролей оператора;
* Оператор - имеет права на операции с объектами модулей Clients, Products, Appeals, Notification, Task, TaskBoard

#### Инфраструктура и интеграция
* *Источник пользователей* - в Project_X CRM источником пользователей может служить как внутренняя БД самой системы, так и СКП. Для упрощения реализации пользователи и роли должны поступать из одного источникаотсутствует возможность иметь разные источники пользователей и ролей (может быть рассмотрена в развитии системы, однако реализация представляется не целесообразной);
* Источник ролей - источником ролей может служить как внутренняя БД самой системы, так и СКП; 
* Источник клиентов;
* Источник заказов;
* Источник настроек; 
* Хост - реальная или виртуальная ЭВМ на которой выполняются один или несколько компонентов системы;
* Порт - адрес на хосте для приёма/получения данных;
* Интеграционный пользователь - учётная запись от имени которой выполняются действия в сторонней системе интегрированной с Project_X;
* Интеграционная роль - набор полномочий достаточный для выполнения необходимых функций в интегрируемой системе;
* Служба каталогов пользователей (далее СКП) - служба-поставщик идентификационных, аутентификационных и авторизационных данных. Может быть построена на любой распространённой технологии, например LDAP

Интеграционный пользователь и интеграционная роль реализуются встроенными механизмами интегрируемых систем и служат только для связи систем между собой

| Определение      | Идентификатор   |
|:--|:--|
|Источник пользователей|Users source|
|Источник ролей|Roles source|
|Источник клиентов|Clients source|
|Источник заказов|Оrders source|
|Источник обращений|Appeals source|
|Источник уведомлений|Notification source|
|Источник задач|Tasks source|

### DFD
![dfd](https://user-images.githubusercontent.com/13516836/167880160-9414b232-3616-4a1b-8e98-98dfb6cba0f0.png)

### Sequence diagram
![sequence](https://user-images.githubusercontent.com/13516836/167880213-56828d8e-a380-48a9-ac8d-cee4a04124a1.png)

### Ограниченные контексты
Для всех ограниченных контекстов существует следующий набор операций:
| Операция      | Комментарий   |
|:--|:--|
|create| В случае сущности - создаёт новую сущность. В случае агрегата - создаёт связь сущностей в агрегате |
|update| В случае сущности - изменяет созданную ранее сущность. В случае агрегата обычно смысла не имеет |
|delete| В случае сущности - удаляет созданную ранее сущность. В случае агрегата разрывает связь сущностей в агрегате|
|search| Ищет сущности или агрегат|
|getInfo| Получает информацию о сущности или агрегате|


### Ограниченный контекст поддомена "Бизнес"
#### Clients
По данным ТЗ Клиенты поставляются из legacy-компонета. Использование такого интерфейса как Источник клиентов позволяет модернизировать систему на получение клиентов из другого источника, например из собственной БД. 

#### Orders
По данным ТЗ Заказы поставляются из legacy-компонент. Использование такого интерфейса как Источник заказов позволяет модернизировать систему для получения заказов из другого источника, например из собственной БД.


### Ограниченный контекст поддомена "Безопасность"
#### Users
В целях дальнейшей интеграции с уже имеющейся корпоративной средой предусмотрена возможность выбирать источник, который будет поставлять пользователей в систему. Таким источником может быть встроенная БД Project_X CRM. В этом случае предоставляется API необходимое для обработки пользователей в системе как с помощью встроенного интерфейса, так и посредством корпоративной системы управления пользователями (IDM). Источником пользователей может быть СКП. В этом случае на операции create, update, delete выполняются на стороне СКП.

#### Roles
Так же как и Пользователей для Ролей предусмотрен выбор источника между встроенной БД системы и СКП. В случае если источником ролей является СКП сreate, update, delete выполняются на стороне её стороне.

#### Entitlements
Список полномочий жестко заданы во внутренней базе данных системы. Их состав зависит от текущей версии приложения и от объектов развернутых в системе.

#### Агрегат RoleEntitlements
Агрегат отражает отношения Роли и Полномочия. Вне зависимости от источника, из которого пришла роль данный агрегат сохраняется во внутренней БД. Операция create добавляет Полномочие в Роль, операция delete - удаляет Полномочие из Роли.

#### Агрегат UserRoles
Агрегат отражает отношения пользователя системы и назначенных ему ролей. Агрегат может как формироваться в БД системы, так и поставляться из СКП. В этом случае операции create и delete не имеют смысла, а реализуются сторонними средствами в СКП.


![Диаграмма классов](/ClassDiagram.svg)	
	


##### Операции
* Clients.create(ClientsSource cs, Client cl)
* Clients.update(ClientsSource cs, Client cl)
* Clients.delete(ClientsSource cs, long id)
* Clients.search(ClientsSource cs, List<String> fieldsNames, String criteria)
* Clients.getInfo(ClientsSource cs, long id)


Сущности и их поля (базовые):
Пользователь
	ФИО - String
	id - int
	роль - dict(role: string - id: int)


Клиент
	ФИО
	id
	Данные (паспорт, телефон)
	тип 
	

Задача
	id 
	тип
	id исполнителя
	описание
	время исполнения
	статус

Заказ
	id 
	тип
	id клиента
	id задачи
	описание
	сумма
	статус
	
